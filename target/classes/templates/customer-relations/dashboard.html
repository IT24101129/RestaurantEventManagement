<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Relations Dashboard - Restaurant Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .dashboard-header {
            background-color: #17a2b8; /* Info blue */
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        }
        .card-header {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .feedback-card {
            border-left: 5px solid #17a2b8;
            margin-bottom: 15px;
        }
        .feedback-card.low-rating {
            border-left-color: #dc3545;
        }
        .feedback-card.high-rating {
            border-left-color: #28a745;
        }
        .feedback-card.escalated {
            border-left-color: #ffc107;
        }
        .feedback-card.anonymous {
            border-left-color: #6c757d;
        }
        .rating-stars {
            color: #ffc107;
            font-size: 1.2em;
        }
        .status-badge-pending { background-color: #ffc107; color: #343a40; }
        .status-badge-inprogress { background-color: #007bff; color: white; }
        .status-badge-responded { background-color: #28a745; color: white; }
        .status-badge-escalated { background-color: #dc3545; color: white; }
        .status-badge-resolved { background-color: #6c757d; color: white; }
        .status-badge-closed { background-color: #343a40; color: white; }
        .priority-badge-low { background-color: #28a745; color: white; }
        .priority-badge-medium { background-color: #ffc107; color: #343a40; }
        .priority-badge-high { background-color: #fd7e14; color: white; }
        .priority-badge-urgent { background-color: #dc3545; color: white; }
        .live-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card .card-body {
            padding: 1.5rem;
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .action-buttons {
            margin-top: 10px;
        }
        .action-buttons .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="live-status">
        <i class="fas fa-circle me-1"></i>Live
    </div>

    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-comments me-2"></i>Customer Relations Dashboard</h1>
                    <p class="mb-0">Feedback Management & Customer Satisfaction</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/dashboard" class="btn btn-outline-light">
                        <i class="fas fa-home me-1"></i>Main Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div id="alertContainer"></div>

        <!-- Statistics Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <div class="stats-number" id="pendingCount">0</div>
                        <div>Pending Feedback</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-star fa-2x mb-2"></i>
                        <div class="stats-number" id="averageRating">0.0</div>
                        <div>Average Rating</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <div class="stats-number" id="escalatedCount">0</div>
                        <div>Escalated Issues</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-user-secret fa-2x mb-2"></i>
                        <div class="stats-number" id="anonymousCount">0</div>
                        <div>Anonymous Feedback</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="feedbackTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                            <i class="fas fa-clock me-1"></i>Pending Feedback
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="low-rating-tab" data-bs-toggle="tab" data-bs-target="#low-rating" type="button" role="tab">
                            <i class="fas fa-thumbs-down me-1"></i>Low Ratings
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="escalated-tab" data-bs-toggle="tab" data-bs-target="#escalated" type="button" role="tab">
                            <i class="fas fa-exclamation-triangle me-1"></i>Escalated
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="anonymous-tab" data-bs-toggle="tab" data-bs-target="#anonymous" type="button" role="tab">
                            <i class="fas fa-user-secret me-1"></i>Anonymous
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                            <i class="fas fa-chart-bar me-1"></i>Reports
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="feedbackTabsContent">
                    <!-- Pending Feedback Tab -->
                    <div class="tab-pane fade show active" id="pending" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-clock me-2"></i>Pending Feedback Entries</h5>
                            </div>
                            <div class="card-body">
                                <div id="pendingFeedbackContainer">
                                    <div class="text-center py-3">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                        <p class="text-muted mt-2">Loading pending feedback...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Low Rating Tab -->
                    <div class="tab-pane fade" id="low-rating" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-thumbs-down me-2"></i>Low Rating Feedback (3 stars and below)</h5>
                            </div>
                            <div class="card-body">
                                <div id="lowRatingFeedbackContainer">
                                    <div class="text-center py-3">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                        <p class="text-muted mt-2">Loading low rating feedback...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Escalated Tab -->
                    <div class="tab-pane fade" id="escalated" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-exclamation-triangle me-2"></i>Escalated Issues</h5>
                            </div>
                            <div class="card-body">
                                <div id="escalatedFeedbackContainer">
                                    <div class="text-center py-3">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                        <p class="text-muted mt-2">Loading escalated feedback...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Anonymous Tab -->
                    <div class="tab-pane fade" id="anonymous" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-user-secret me-2"></i>Anonymous Feedback</h5>
                            </div>
                            <div class="card-body">
                                <div id="anonymousFeedbackContainer">
                                    <div class="text-center py-3">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                        <p class="text-muted mt-2">Loading anonymous feedback...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div class="tab-pane fade" id="reports" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar me-2"></i>Satisfaction Reports</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="reportType" class="form-label">Report Type</label>
                                        <select class="form-select" id="reportType">
                                            <option value="DAILY">Daily Report</option>
                                            <option value="WEEKLY">Weekly Report</option>
                                            <option value="MONTHLY" selected>Monthly Report</option>
                                            <option value="QUARTERLY">Quarterly Report</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="periodStart" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="periodStart">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="periodEnd" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="periodEnd">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <button class="btn btn-primary w-100" onclick="generateReport()">
                                            <i class="fas fa-chart-line me-1"></i>Generate
                                        </button>
                                    </div>
                                </div>
                                <div id="reportContainer">
                                    <div class="text-center py-3">
                                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Generate a satisfaction report to view analytics</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Modal -->
    <div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="responseModalLabel">Respond to Feedback</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="feedbackDetails"></div>
                    <hr>
                    <form id="responseForm">
                        <input type="hidden" id="feedbackId">
                        <div class="mb-3">
                            <label for="responseType" class="form-label">Response Type</label>
                            <select class="form-select" id="responseType" required>
                                <option value="">Select response type</option>
                                <option value="ACKNOWLEDGMENT">Acknowledgment</option>
                                <option value="APOLOGY">Apology</option>
                                <option value="EXPLANATION">Explanation</option>
                                <option value="RESOLUTION">Resolution</option>
                                <option value="ESCALATION">Escalation</option>
                                <option value="FOLLOW_UP">Follow-up</option>
                                <option value="PROMOTIONAL_OFFER">Promotional Offer</option>
                                <option value="GENERAL_RESPONSE">General Response</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="responseText" class="form-label">Response Text</label>
                            <textarea class="form-control" id="responseText" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isInternal">
                                <label class="form-check-label" for="isInternal">
                                    Internal response (not sent to customer)
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="escalationNotes" class="form-label">Escalation Notes (if applicable)</label>
                            <textarea class="form-control" id="escalationNotes" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="followUpRequired">
                                <label class="form-check-label" for="followUpRequired">
                                    Schedule follow-up reminder
                                </label>
                            </div>
                        </div>
                        <div class="mb-3" id="followUpDateContainer" style="display: none;">
                            <label for="followUpDate" class="form-label">Follow-up Date</label>
                            <input type="datetime-local" class="form-control" id="followUpDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitResponse()">Submit Response</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Promotional Offer Modal -->
    <div class="modal fade" id="promotionalOfferModal" tabindex="-1" aria-labelledby="promotionalOfferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="promotionalOfferModalLabel">Send Promotional Offer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="promotionalOfferDetails"></div>
                    <hr>
                    <form id="promotionalOfferForm">
                        <input type="hidden" id="promotionalFeedbackId">
                        <div class="mb-3">
                            <label for="offerDetails" class="form-label">Offer Details</label>
                            <textarea class="form-control" id="offerDetails" rows="4" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="sendPromotionalOffer()">Send Offer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let refreshInterval;

        $(document).ready(function() {
            startRealTimeUpdates();
            setupEventListeners();
            loadInitialData();
        });

        function setupEventListeners() {
            // Follow-up checkbox toggle
            $('#followUpRequired').change(function() {
                if ($(this).is(':checked')) {
                    $('#followUpDateContainer').show();
                } else {
                    $('#followUpDateContainer').hide();
                }
            });

            // Set default dates for report generation
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            $('#periodStart').val(lastMonth.toISOString().split('T')[0]);
            $('#periodEnd').val(today.toISOString().split('T')[0]);
        }

        function startRealTimeUpdates() {
            refreshInterval = setInterval(refreshData, 30000); // Refresh every 30 seconds
            refreshData(); // Initial load
        }

        function refreshData() {
            loadPendingFeedback();
            loadLowRatingFeedback();
            loadEscalatedFeedback();
            loadAnonymousFeedback();
            loadStatistics();
        }

        function loadInitialData() {
            refreshData();
        }

        function loadPendingFeedback() {
            fetch('/customer-relations/api/pending-feedback')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updatePendingFeedback(data.feedback);
                    } else {
                        showAlert('error', data.error);
                    }
                })
                .catch(error => {
                    showAlert('error', 'Failed to load pending feedback: ' + error.message);
                });
        }

        function loadLowRatingFeedback() {
            fetch('/customer-relations/api/low-rating-feedback')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateLowRatingFeedback(data.feedback);
                    } else {
                        showAlert('error', data.error);
                    }
                })
                .catch(error => {
                    showAlert('error', 'Failed to load low rating feedback: ' + error.message);
                });
        }

        function loadEscalatedFeedback() {
            fetch('/customer-relations/api/escalated-feedback')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateEscalatedFeedback(data.feedback);
                    } else {
                        showAlert('error', data.error);
                    }
                })
                .catch(error => {
                    showAlert('error', 'Failed to load escalated feedback: ' + error.message);
                });
        }

        function loadAnonymousFeedback() {
            fetch('/customer-relations/api/anonymous-feedback')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateAnonymousFeedback(data.feedback);
                    } else {
                        showAlert('error', data.error);
                    }
                })
                .catch(error => {
                    showAlert('error', 'Failed to load anonymous feedback: ' + error.message);
                });
        }

        function loadStatistics() {
            fetch('/customer-relations/api/statistics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateStatistics(data.statistics);
                    } else {
                        showAlert('error', data.error);
                    }
                })
                .catch(error => {
                    showAlert('error', 'Failed to load statistics: ' + error.message);
                });
        }

        function updatePendingFeedback(feedbackList) {
            const container = $('#pendingFeedbackContainer');
            container.empty();

            if (feedbackList.length === 0) {
                container.append(`
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <p class="text-muted">No pending feedback at this time.</p>
                    </div>
                `);
                return;
            }

            feedbackList.forEach(feedback => {
                container.append(createFeedbackCard(feedback, 'pending'));
            });
        }

        function updateLowRatingFeedback(feedbackList) {
            const container = $('#lowRatingFeedbackContainer');
            container.empty();

            if (feedbackList.length === 0) {
                container.append(`
                    <div class="text-center py-3">
                        <i class="fas fa-thumbs-up fa-3x text-success mb-3"></i>
                        <p class="text-muted">No low rating feedback at this time.</p>
                    </div>
                `);
                return;
            }

            feedbackList.forEach(feedback => {
                container.append(createFeedbackCard(feedback, 'low-rating'));
            });
        }

        function updateEscalatedFeedback(feedbackList) {
            const container = $('#escalatedFeedbackContainer');
            container.empty();

            if (feedbackList.length === 0) {
                container.append(`
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <p class="text-muted">No escalated issues at this time.</p>
                    </div>
                `);
                return;
            }

            feedbackList.forEach(feedback => {
                container.append(createFeedbackCard(feedback, 'escalated'));
            });
        }

        function updateAnonymousFeedback(feedbackList) {
            const container = $('#anonymousFeedbackContainer');
            container.empty();

            if (feedbackList.length === 0) {
                container.append(`
                    <div class="text-center py-3">
                        <i class="fas fa-user fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No anonymous feedback at this time.</p>
                    </div>
                `);
                return;
            }

            feedbackList.forEach(feedback => {
                container.append(createFeedbackCard(feedback, 'anonymous'));
            });
        }

        function createFeedbackCard(feedback, type) {
            const statusClass = `status-badge-${feedback.status.toLowerCase()}`;
            const priorityClass = `priority-badge-${feedback.priority.toLowerCase()}`;
            const cardClass = `feedback-card ${type}`;
            
            const stars = '★'.repeat(feedback.rating) + '☆'.repeat(5 - feedback.rating);
            const customerName = feedback.isAnonymous ? 'Anonymous' : feedback.customerName;
            const customerEmail = feedback.isAnonymous ? 'N/A' : feedback.customerEmail;
            
            return `
                <div class="card ${cardClass}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="card-title">${feedback.subject || 'No Subject'}</h6>
                                <p class="card-text">
                                    <strong>Customer:</strong> ${customerName}<br>
                                    <strong>Email:</strong> ${customerEmail}<br>
                                    <strong>Rating:</strong> <span class="rating-stars">${stars}</span> (${feedback.rating}/5)<br>
                                    <strong>Type:</strong> ${feedback.feedbackType}<br>
                                    <strong>Priority:</strong> <span class="badge ${priorityClass}">${feedback.priority}</span><br>
                                    <strong>Status:</strong> <span class="badge ${statusClass}">${feedback.status}</span>
                                </p>
                                <p class="card-text"><strong>Comment:</strong> ${feedback.comment || 'No comment provided'}</p>
                            </div>
                            <div class="col-md-4">
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-sm" onclick="openResponseModal(${feedback.id})">
                                        <i class="fas fa-reply me-1"></i>Respond
                                    </button>
                                    ${feedback.rating <= 2 ? `
                                        <button class="btn btn-warning btn-sm" onclick="handleLowRating(${feedback.id})">
                                            <i class="fas fa-gift me-1"></i>Promotional Offer
                                        </button>
                                    ` : ''}
                                    ${feedback.isAnonymous ? `
                                        <button class="btn btn-info btn-sm" onclick="handleAnonymous(${feedback.id})">
                                            <i class="fas fa-user-secret me-1"></i>Handle Anonymous
                                        </button>
                                    ` : ''}
                                    ${feedback.isEscalated ? `
                                        <button class="btn btn-danger btn-sm" onclick="handleEscalation(${feedback.id})">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Handle Escalation
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStatistics(statistics) {
            $('#pendingCount').text(statistics.pendingFeedbackCount || 0);
            $('#averageRating').text((statistics.weeklyAverageRating || 0).toFixed(1));
            $('#escalatedCount').text(statistics.escalatedFeedbackCount || 0);
            $('#anonymousCount').text(statistics.anonymousFeedbackCount || 0);
        }

        function openResponseModal(feedbackId) {
            $('#feedbackId').val(feedbackId);
            $('#responseModal').modal('show');
        }

        function submitResponse() {
            const feedbackId = $('#feedbackId').val();
            const responseType = $('#responseType').val();
            const responseText = $('#responseText').val();
            const isInternal = $('#isInternal').is(':checked');
            const escalationNotes = $('#escalationNotes').val();
            const followUpRequired = $('#followUpRequired').is(':checked');
            const followUpDate = $('#followUpDate').val();

            if (!responseType || !responseText) {
                showAlert('error', 'Please fill in all required fields');
                return;
            }

            const requestData = {
                responseType: responseType,
                responseText: responseText,
                isInternal: isInternal,
                escalationNotes: escalationNotes,
                followUpRequired: followUpRequired,
                followUpDate: followUpDate
            };

            $.ajax({
                url: `/customer-relations/feedback/${feedbackId}/respond`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        $('#responseModal').modal('hide');
                        refreshData();
                    } else {
                        showAlert('error', response.error);
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Error submitting response: ' + xhr.responseText);
                }
            });
        }

        function handleLowRating(feedbackId) {
            $.ajax({
                url: `/customer-relations/feedback/${feedbackId}/handle-low-rating`,
                type: 'POST',
                success: function(response) {
                    if (response.success && response.handling.suggestPromotionalOffer) {
                        $('#promotionalFeedbackId').val(feedbackId);
                        $('#promotionalOfferDetails').html(`
                            <div class="alert alert-warning">
                                <h6>Low Rating Detected</h6>
                                <p>This feedback has a rating of ${response.handling.feedbackId} or below. 
                                Consider sending a promotional offer to improve customer satisfaction.</p>
                                <p><strong>Suggested Offer:</strong> ${response.handling.promotionalOffer}</p>
                            </div>
                        `);
                        $('#offerDetails').val(response.handling.promotionalOffer);
                        $('#promotionalOfferModal').modal('show');
                    } else {
                        showAlert('info', 'No promotional offer needed for this feedback');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Error handling low rating: ' + xhr.responseText);
                }
            });
        }

        function sendPromotionalOffer() {
            const feedbackId = $('#promotionalFeedbackId').val();
            const offerDetails = $('#offerDetails').val();

            if (!offerDetails) {
                showAlert('error', 'Please provide offer details');
                return;
            }

            $.ajax({
                url: `/customer-relations/feedback/${feedbackId}/send-promotional-offer`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ offerDetails: offerDetails }),
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        $('#promotionalOfferModal').modal('hide');
                        refreshData();
                    } else {
                        showAlert('error', response.error);
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Error sending promotional offer: ' + xhr.responseText);
                }
            });
        }

        function handleAnonymous(feedbackId) {
            $.ajax({
                url: `/customer-relations/feedback/${feedbackId}/handle-anonymous`,
                type: 'POST',
                success: function(response) {
                    if (response.success && response.handling.isAnonymous) {
                        showAlert('info', 'Anonymous feedback detected. Response options are limited to general acknowledgments.');
                        $('#responseText').val(response.handling.suggestedResponse);
                        $('#responseType').val('GENERAL_RESPONSE');
                        openResponseModal(feedbackId);
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Error handling anonymous feedback: ' + xhr.responseText);
                }
            });
        }

        function handleEscalation(feedbackId) {
            $.ajax({
                url: `/customer-relations/feedback/${feedbackId}/handle-escalation`,
                type: 'POST',
                success: function(response) {
                    if (response.success && response.handling.needsFollowUp) {
                        showAlert('warning', 'Escalated issue requires follow-up. Scheduling reminder...');
                        // Schedule follow-up reminder
                        const followUpDate = new Date();
                        followUpDate.setDate(followUpDate.getDate() + 1);
                        
                        $.ajax({
                            url: `/customer-relations/feedback/${feedbackId}/schedule-follow-up`,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ followUpDate: followUpDate.toISOString() }),
                            success: function(followUpResponse) {
                                if (followUpResponse.success) {
                                    showAlert('success', 'Follow-up reminder scheduled');
                                }
                            }
                        });
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Error handling escalation: ' + xhr.responseText);
                }
            });
        }

        function generateReport() {
            const reportType = $('#reportType').val();
            const periodStart = $('#periodStart').val();
            const periodEnd = $('#periodEnd').val();

            if (!periodStart || !periodEnd) {
                showAlert('error', 'Please select both start and end dates');
                return;
            }

            const requestData = {
                reportType: reportType,
                periodStart: periodStart,
                periodEnd: periodEnd
            };

            $.ajax({
                url: '/customer-relations/reports/generate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function(response) {
                    if (response.success) {
                        displayReport(response.report);
                        showAlert('success', response.message);
                    } else {
                        showAlert('error', response.error);
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Error generating report: ' + xhr.responseText);
                }
            });
        }

        function displayReport(report) {
            const container = $('#reportContainer');
            container.html(`
                <div class="card">
                    <div class="card-header">
                        <h5>${report.reportType} Report - ${report.periodStart} to ${report.periodEnd}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="text-primary">${report.totalFeedbackCount}</h3>
                                    <p class="text-muted">Total Feedback</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="text-success">${report.averageRating ? report.averageRating.toFixed(1) : 'N/A'}</h3>
                                    <p class="text-muted">Average Rating</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="text-warning">${report.satisfactionScore ? report.satisfactionScore.toFixed(1) + '%' : 'N/A'}</h3>
                                    <p class="text-muted">Satisfaction Score</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="text-danger">${report.criticalIssuesCount}</h3>
                                    <p class="text-muted">Critical Issues</p>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Summary</h6>
                                <p>${report.summary || 'No summary available'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Critical Issues</h6>
                                <p>${report.criticalIssuesSummary || 'No critical issues identified'}</p>
                            </div>
                        </div>
                        ${report.recommendations ? `
                            <div class="mt-3">
                                <h6>Recommendations</h6>
                                <p>${report.recommendations}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);
        }

        function showAlert(type, message) {
            const alertContainer = $('#alertContainer');
            const alertClass = type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success';
            const alertHtml = `
                <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertContainer.html(alertHtml);
            setTimeout(() => {
                alertContainer.empty();
            }, 5000);
        }
    </script>
</body>
</html>
